# 源码贡献指南

![](https://img.shields.io/badge/version-1.0.0-green)

## 通过 Github 贡献代码

> 如果你想要参与某个项目，但是并没有推送权限，这时可以对这个项目进行 Fork。Fork 时，GitHub 会在你的空间中创建一个完全属于你的项目副本，且你对其具有推送权限。将修改推送到 Fork 出的项目副本后，可以通过创建拉取请求（Pull Request，简称 PR）来让改动进入源版本库。创建了拉取请求后，就会开启一个可供审查代码的板块，项目的拥有者和贡献者可以在此讨论相关修改，直到项目拥有者对其感到满意，并且认为这些修改可以被合并到版本库。

对于组件仓库、各兵种机器人的开发仓库，请通过 GitHub 的 Fork 和 Pull Request 流程来提交代码。贡献流程简要介绍如下：

* 将仓库 Fork 到自己的工作空间中
* 将工作空间中的仓库克隆（clone）到本地
* 从 `master/main` 分支创建自己的开发分支
* 在自己的开发分支进行开发，为项目添加新的特性或改进项目，开发过程请遵循开发规范
* 提交（commit）一些修改
* 将这个分支推送（push）到 GitHub 上
* 创建一个拉取请求（PR）
* 项目拥有者审核代码，交流讨论，根据实际情况继续修改
* 项目的拥有者将贡献合并（merge）到主分支或关闭（close）拉取请求

建议及时将最新的 `master/main` 分支同步到你的 Fork 中。

### Commit 格式

使用以下格式提交 commit，不限制中英文：

```
<type>(<scope>): <subject>
 - 必要栏位：type 代表 commit 的类别
 - 可选栏位：scope 代表 commit 影响的范围，如 Middlewares, Devices...
 - 必要栏位：subject 代表此 commit 的简短描述，50 字以内，结尾不要加句号
```

type 只允许使用以下类别：

| <type\> | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| feat     | 新增/修改功能 (feature)                                      |
| fix      | 修补bug (bug fix)                                            |
| docs     | 文件 (documentation)                                         |
| style    | 格式 (不影响程式码运行的变动white-space, formatting, missing semi colons, etc) |
| refactor | 重构 (既不是新增功能，也不是修补bug 的程式码变动)            |
| perf     | 改善效能 (A code change that improves performance)           |
| test     | 增加测试 (when adding missing tests)                         |
| chore    | 建构程序或辅助工具的变动 (maintain)                          |
| revert   | 撤销回退先前的 commit                                        |

### PR 要求

* 请使用清晰的文字或图文，详细描述 PR 目标、涵盖的全部内容、反馈需求等
* 请确保 PR 的内容足够精简且单一，且通过实际的测试



## 开发规范

开发过程中，请遵循原项目的文件组织、软件架构和代码风格。

* [Hello World 嵌入式文件组织规范](https://zju-helloworld.github.io/Wiki/%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/%E6%96%87%E4%BB%B6%E7%BB%84%E7%BB%87%E8%A7%84%E8%8C%83/)
* [Hello World 嵌入式软件架构](https://zju-helloworld.github.io/Wiki/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/%E5%B5%8C%E5%85%A5%E5%BC%8F%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/)
* [Hello World 嵌入式编程风格指南](https://zju-helloworld.github.io/Wiki/%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/%E7%BC%96%E7%A8%8B%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97/)



## 添加...

### 添加新组件

添加任何组件时，需要在说明文档中注明文件依赖关系；通过测试后，请在 [HW-Components 仓库](https://github.com/ZJU-HelloWorld/HW-Components) 提交 Pull Request.

#### 添加板级驱动

板级设备驱动对应一种设备总线驱动，请基于 HAL 库开发。

*依赖*	仅允许包含  `system.h`

*添加流程*

* 将一对新板级驱动文件`.c/.h`加入`./BSP`
* 在 `board.h` 中包含对应的 `.h` 文件

#### 添加设备

设备应独立于操作系统和任何应用工作。请基于现有板级外设驱动（BSP）开发；若没有合适的接口可供使用，请谨慎为队内编写的外设驱动增添新内容。推荐设备为统一接入中间件层（Middleware）提供的设备管理器留出接口。

*依赖*	允许设备组件包含 `./Middleware` 目录下的设备管理器，允许包含 `./BSP` 目录下的外设驱动，允许包含  `./Utils` 目录下的实用工具，允许包含 `system.h`

*添加流程*

* 将一对新设备文件`.c/.h`加入`./Devices`
* 在 `device.h` 中包含对应的 `.h` 文件
* 在 `dev_config.h` 中进行对应设备的外设句柄设置

#### 添加算法

算法应独立于操作系统和其他组件工作。请单独仿真测试，确保算法运行符合预期后，再将其加入组件库。

*依赖*	允许算法组件包含 `./Algorithms` 目录下其他算法（非必要不添加依赖），允许包含  `./Utils` 目录下的实用工具，允许包含 `system.h`

*添加流程*

* 将一对新算法文件`.c/.h`加入`./Algorithms`

#### 添加中间件

中间件可以依赖于操作系统，但应独立于其他组件工作。请单独测试，确保中间件运行符合预期后，再将其加入组件库。

*依赖*	允许中间件组件包含操作系统内核，允许包含 `./Utils` 目录下的实用工具，允许包含 `system.h`

*添加流程*

* 必要时，在`./Middlewares` 下创建新中间件组件目录
* 将新中间件文件`.c/.h ` 加入`./Middlewares` 或新创建的目录
* 在 `config.h` 中添加对应的组件开关

#### 添加实用工具

实用工具应完全独立工作。请确保实用工具能实现预期功能后，再将其加入组件库。

*依赖*	不允许任何依赖

### 添加新应用

在机器人嵌入式系统工程中添加新应用，有以下建议。

#### 添加新模块

请基于现有组件开发；若没有合适的接口可供使用，请按照组件添加规则进行组件的贡献。

*添加流程*

* 将一对新模块 `.c/.h` 文件加入 `./Modules`

#### 添加新任务

机器人开发中，任务的内容应定义为 `模块实例化 + 执行逻辑`，应基于模块开发；嵌入式系统中，任务应遵循现有框架及中间件组件，来实现任务初始化、调度、通信等所需功能。

*添加流程*

* 将一对新任务 `.c/.h` 文件加入 `./Tasks`



## 测试

### 单元测试

若开发新组件，请在开发板上对新特性进行单元测试，全面地设计测试用例并保证组件运行符合期望。

### 系统测试

若在实机上进行源码的修改，请做回归测试，确保整个系统工作正常。

若在实机上开发新功能，请做功能集成测试，确保单一模块或子系统功能正常，运行符合期望；随即做系统测试，确保添加新特性后整个系统工作正常。

### 压力测试

为保证机器人在场上的稳定表现，请适时以训练赛或其他形式进行压力测试。



## 更换开发板

更换开发板时，需进行包括但不限于以下步骤：

* 使用 STM32CubeMX 生成新的工程模板
* 主要更改全部外设驱动（BSP）接口定义 `BSP`
* 更改具体设备对应的外设句柄配置 `Devices/dev_config.h`
* 更改 RTOS 时钟源句柄 `Middlewares/config.h`



## 附录

### 版本说明

| 版本号                                                       | 发布日期   | 说明     | 贡献者 |
| ------------------------------------------------------------ | ---------- | -------- | ------ |
| <img src = "https://img.shields.io/badge/version-1.0.0-green" > | 2022.12.17 | 首次发布 | 薛东来 |
