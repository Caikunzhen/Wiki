# 机器人软件系统架构

![hh](https://img.shields.io/badge/version-0.9.2-green)

## 写在前面

在设计机器人系统时，需要遵循一定的体系结构，使各部分、各层级功能充分解耦、各司其职、密切合作、流畅运行，以实现系统的全部功能和特性。机器人系统是嵌入式系统的一种，而对于一个一般的嵌入式系统而言，其体系结构包括嵌入式系统的元素、与嵌入式系统交互的元素、每个单独元素的属性以及元素之间的交互关系。常见的嵌入式系统模型如下图所示：

![](机器人软件系统架构.assets/img_1_9_1.png)

在概念上，这些模型适用于任何嵌入式系统；但对应于实际开发过程，应结合应用需求，对其进行适当的补充和调整，使各概念的含义更清晰、各模块功能更明确，以适用于机器人系统的开发。

大到一个机器人开发团队的软件工作、小到每一位成员的代码产出，写出能用的程序固然重要，但也要考虑到设计上的逻辑性、合理性和可移植、可拓展性。唯有如此，才能够提升开发和维护的效率，维持软件的活力，帮助团队持续稳定地发展。没有架构设计或不合理的架构设计，其弊端已经在过往的赛季中逐渐显现，是时候推广一个更为完善、更有发展潜力的架构，来**理清对象逻辑层次关系，合理设计系统流程架构，引导自研应用生态发展**。

因此，我们参考大量资料，包括 *[STM32Cube Package 架构](机器人软件系统架构.assets/STM32Cube Package Content.png)*，*[DJI 自动驾驶域控制器架构](机器人软件系统架构.assets/DJI Autonomous Driving Domain Controller.png)*，*[RT-Thread I/O 设备模型](rtt_io.png)* 等，结合开发过程和应用的实际需求，形成战队机器人软件系统架构；该架构尚不成熟，需要更多的队员秉承科学的设计理念，不断优化和完善。

## 软件架构概述

嵌入式软件大体上可以分为两大类：**系统软件**和**应用软件**。系统软件是支持应用程序的任何软件，例如设备驱动程序、操作系统和中间件。应用软件是上层软件，它定义了嵌入式设备的功能和用途，并处理与用户的大部分交互。

以步兵机器人的软件架构为例，下图中彩色色块覆盖的部分代表应用软件，其他部分代表系统软件及硬件。

![swerve-architecture](%E6%9C%BA%E5%99%A8%E4%BA%BA%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.assets/swerve-architecture.png)

以下部分将介绍具体模型，从体系结构层级的抽象向下具体到伪代码层级。

## 系统软件层（System Software Layer）

### 硬件抽象层（Hardware Abstraction Layer, HAL）

大多数嵌入式硬件需要某种类型的软件初始化和管理。HAL 是对硬件的抽象和封装，为软件提供了统一的硬件设备访问接口。HAL 涉及的各层级 STM32 外设包括 GPIO、TIM、IWDG、USART、SPI、CAN、I2C...

> STM32Cube HAL 为此提供了支持。

### 板级支持包（Board Support Package）

BSP 是进一步调用 HAL 的各种方法实现硬件配置、外设初始化、功能聚合等，从而为 STM32 片上硬件实现的可直接调用的功能支持包。上层模块调用板级支持包提供的接口，而无需关注 HAL 库及其他底层细节。在应用时，BSP 仅与对应外设自身功能相关，该层对数据的描述不具有特定含义。

> 使用 STM32CubeMX 生成项目时，外设配置相关的 BSP 将自动生成。

#### 设备驱动（Device Driver）

设备驱动程序是 BSP 的主要组成部分，是对 HAL 提供方法的再一次封装，提供统一易用的驱动接口以及驱动注册、软件 FIFO、回调函数注册等功能。按照外设的类型，编写对应的驱动（如 drv_can, drv_i2c...），以驱动对应类型的设备。

> 设备驱动是战队自研系统软件支持的一部分。对于新增加的外设，请编写独立、可移植复用的应用程序，并加入驱动库中。

### 操作系统（Operating System）

嵌入式系统对实时性要求较高，采用实时操作系统（Real Time Operating System）。RTOS 的核心功能如下：

![FreeRTOS Core](%E6%9C%BA%E5%99%A8%E4%BA%BA%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.assets/FreeRTOS%20Core-16760303509641.png)

> 我们选用 FreeRTOS 进行开发。STM32Cube Packge 将 RTOS 内核组件定义在 Middleware 层级，在此不做改动。

### 中间件（Middleware）

一般而言，中间件软件是任何不是操作系统内核、设备驱动程序或应用程序的系统软件。为便于区分系统软件和与机器人开发相关的软件，机器人抽象组件（如实用工具、设备应用、算法组件等）和模组将被定义到应用软件层，但它们严格意义上也属于中间件，允许任务重用。

在本架构中，中间件包括：

* RTOS 内核
* 已经包含在现成支持包中的应用软件，如 USB 应用支持
* 第三方供应商提供的现成软件（ *.lib 等）
* 自研设备统一管理框架
* 自研通信服务组件、内存管理、Shell、日志、自定义通信协议等操作系统扩展组件

> 自研中间件是战队自研系统软件支持的一部分。按照操作系统的扩展需求，基于 FreeRTOS 进行研发。

## 应用软件层（Application Software Layer）

#### 组件（Component）

组件是一些独立模块，在嵌入式系统中发挥功能但不与其他模块耦合。

* **设备应用（Device）**

  设备是组成机器人的最小单元，包括电机、遥控系统、裁判系统等等单一独立模块。设备应用对实体设备进行抽象，管理更高层软件对设备的访问；同时，设计设备与设备驱动匹配的程序接口，控制设备对象所需的底层数据交互。设备驱动内容主要包括：

  * 构造和初始化方法；
  * 数据处理、解析方法；
  * 特定封装的驱动方法。

> 设备应用基于 Device Driver 提供的通用外设操作方法进行开发，是战队电控的通用组件之一。对于新增加的设备，建议编写独立、可移植复用的应用程序，并加入组件库中

* **算法（Algorithm）**

  算法区别于实体，作为抽象的功能模块存在于架构中。

> 算法是战队电控的通用组件之一。对于新增加的算法，建议编写独立、可移植复用的应用程序，并加入组件库中

* **简单功能聚合（Tool）**

#### 模组（Module）

模组是组成机器人的具有一定聚合关系的实体组件集合或抽象模块，如云台、底盘、错误检测器等，彼此独立、耦合度低。模组驱动对为任务提供应用接口。

> 模组驱动由各兵种实现，可复用的模组应尽量协作完成

#### 任务 / 线程（Task / Thread）

任务依赖于系统软件，由系统软件管理和调度。任务描述该嵌入式系统最高级的目的，简介清晰地展示运行过程，并与用户进行了大部分交互；除此之外还有一些通用系统必要的任务，如消息处理任务、错误诊断任务等。

> 任务 / 线程按实际任务需求进行实现

## 附录

### 版本说明

| 版本号                                                  | 发布日期 | 说明                   | 贡献者 |
| ------------------------------------------------------- | -------- | ---------------------- | ------ |
| ![hh](https://img.shields.io/badge/version-0.9.1-green) | 2022.09  | 预发布，适用于裸机架构 | 薛东来 |
| ![hh](https://img.shields.io/badge/version-0.9.2-green) | 2023.02  | 适用于 RTOS            | 薛东来 |

### 参考资料

[1] Tammy Noerga, *Embedded Systems Architecture - A Comprehensive Guide for Engineers and Programmers*.

[2] [Development guidelines for STM32Cube Expansion Packages](https://www.st.com/resource/en/user_manual/um2285-development-guidelines-for-stm32cube-expansion-packages-stmicroelectronics.pdf).

[3] [Mastering the FreeRTOS Real Time Kernel - A Hands-On Tutorial Guide](https://www.freertos.org/fr-content-src/uploads/2018/07/161204_Mastering_the_FreeRTOS_Real_Time_Kernel-A_Hands-On_Tutorial_Guide.pdf).

